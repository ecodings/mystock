<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ë§¤ë§¤ ì¼ì§€</title>
    <link rel="icon" type="image/x-icon" href="stock.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            font-size: 17px;
            zoom: 0.67;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            flex: 0 0 auto;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .header h1 {
            font-size: 27px;
            color: #2c3e50;
        }
        
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 17px;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #2980b9;
        }
        
        .price-mode-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 17px;
            transition: background 0.3s;
        }
        
        .price-mode-btn:hover {
            background: #7f8c8d;
        }
        
        .price-mode-btn.active {
            background: #27ae60;
        }
        
        .price-mode-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .container {
            flex: 1;
            display: grid;
            grid-template-columns: 60% 40%;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
            min-height: 0;  /* ğŸ‘ˆ ì¶”ê°€ */
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-y: auto;
            min-height: 0;  /* ğŸ‘ˆ ì¶”ê°€ */
        }
        
        /* ì¢Œì¸¡ íŒ¨ë„ */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            min-height: 0;
        }

        .left-panel > .panel:first-child {
            flex: 1;  /* ğŸ‘ˆ 80% */
            min-height: 0;
            overflow-y: auto;
        }
        
        .left-panel > .panel:last-child {
            flex: 0 0 400px;  /* ğŸ‘ˆ 20% */
            min-height: 0;
            overflow-y: auto;
        }
        
        .accounts-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;  /* ğŸ‘ˆ 3ì—´ ê·¸ë¦¬ë“œ */
            gap: 15px;
        }
        
        .account-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .account-title {
            font-size: 23px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
        }
        
        .stock-item {
            background: white;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .stock-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        
        .stock-item.active {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .stock-name {
            font-size: 21px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .stock-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            font-size: 18px;
            color: #6c757d;
            margin-bottom: 6px;
        }
        
        .stock-info-label {
            font-size: 15px;
            color: #95a5a6;
            margin-top: 4px;
        }
        
        .profit-positive {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .profit-negative {
            color: #3498db;
            font-weight: 600;
        }
        
        .trade-history {
            flex: 1;
        }
        
        .trade-history-title {
            font-size: 19px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            line-height: 1.4;
        }
        
        .trade-history-profit {
            font-size: 21px;
            font-weight: bold;
            margin-bottom: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }
        
        #tradeHistoryContainer {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .trade-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .trade-date {
            color: #6c757d;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        /* ë‚ ì§œë³„ ê±°ë˜ ìƒì„¸ (ë°•ìŠ¤í˜•) */
        .date-trade-detail {
            background: #f8f9fa;
            border-radius: 6px;  /* ğŸ‘ˆ 8px â†’ 6px */
            padding: 10px;  /* ğŸ‘ˆ 15px â†’ 10px */
            border-left: 4px solid #3498db;
        }
        
        .date-trade-detail.buy-item {
            border-left-color: #e74c3c;
        }
        
        .date-trade-detail.sell-item {
            border-left-color: #3498db;
        }
        
        .trade-type-box {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .trade-type-box.buy {
            background: #fee;
            color: #e74c3c;
        }
        
        .trade-type-box.sell {
            background: #eef;
            color: #3498db;
        }
        
        .trade-stock-name {
            font-size: 19px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .trade-detail-vertical {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 17px;
            color: #6c757d;
        }
        
        /* ìš°ì¸¡ íŒ¨ë„ */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;  /* ğŸ‘ˆ ì¶”ê°€ */
            min-height: 0;  /* ğŸ‘ˆ ì¶”ê°€ */
            overflow: hidden;
        }
        
        .calendar-section {
            flex: 1;  /* ğŸ‘ˆ ë‚˜ë¨¸ì§€ ê³µê°„ ì „ë¶€ */
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .filter-btn {
            background: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: #3498db;
            color: white;
        }
        
        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-selector select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 17px;
        }
        
        .month-nav-btn {
            background: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 21px;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .month-nav-btn:hover {
            background: #bdc3c7;
        }
        
        .current-stock-name {
            font-size: 23px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .calendar {
            flex: 1;  /* ğŸ‘ˆ ì¶”ê°€ */
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: auto;  /* ğŸ‘ˆ hidden â†’ auto */
            display: flex;
            flex-direction: column;
        }
        
        .calendar-header-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 4px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            flex: 1;  /* ğŸ‘ˆ ì¶”ê°€ */
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 10px 4px;
            font-size: 17px;
            font-weight: bold;
            color: #6c757d;
        }
        
        .calendar-day {
            aspect-ratio: 1.4;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 8px 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            font-size: 14px;
        }
        
        .calendar-day:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .calendar-day.active {
            background: #f0f4f8;
            color: #2c3e50;
            border-color: #3498db;
        }
        
        .calendar-day.empty {
            background: #f8f9fa;
            cursor: default;
        }
        
        .calendar-day.empty:hover {
            transform: none;
            box-shadow: none;
        }
        
        .day-number {
            font-size: 19px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .day-buy {
            font-size: 16px;
            color: #e74c3c;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .day-sell {
            font-size: 16px;
            color: #3498db;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .calendar-summary {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 6px;
        }
        
        .summary-value {
            font-size: 23px;
            font-weight: bold;
        }
        
        /* íƒ­ ì˜ì—­ */
        .tab-section {
            flex: 0 0 400px;  /* ğŸ‘ˆ ê³ ì • ë†’ì´ */
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab-btn {
            flex: 1;
            background: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
            flex: 1;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* ë„ë„› ì°¨íŠ¸ ì˜ì—­ */
        .donut-charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;  /* ğŸ‘ˆ flex â†’ grid */
            gap: 15px;  /* ğŸ‘ˆ 10px â†’ 15px */
            flex: 1;
            min-height: 0;
            background: #f8f9fa;  /* ğŸ‘ˆ ì¶”ê°€ */
            border-radius: 8px;  /* ğŸ‘ˆ ì¶”ê°€ */
            padding: 15px;  /* ğŸ‘ˆ ì¶”ê°€ */
        }
        
        .donut-chart-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 8px;
            padding: 10px;
            max-height: 350px;  /* ğŸ‘ˆ 280px â†’ 350px */
        }
        
        .donut-chart-title {
            font-size: 17px;  /* ğŸ‘ˆ 16px â†’ 14px */
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;  /* ğŸ‘ˆ 10px â†’ 5px */
            text-align: center;
        }
        
        .donut-chart-canvas {
            flex: 1;
            position: relative;
            min-height: 0;  /* ğŸ‘ˆ ì¶”ê°€ */
        }
        
        /* ë§¤ë§¤ì¼ê¸° */
        .diary-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .diary-textarea {
            flex: 1;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            font-size: 17px;
            resize: none;
            font-family: inherit;
            line-height: 1.6;
        }
        
        .diary-save-btn {
            margin-top: 10px;
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
        }
        
        .diary-save-btn:hover {
            background: #229954;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
            font-size: 17px;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 30px; flex: 1;">
            <div>
                <h1>ğŸ“Š ì£¼ì‹ ë§¤ë§¤ ì¼ì§€</h1>
                <div id="priceUpdateTime" style="font-size: 17px; color: #7f8c8d; margin-top: 4px;"></div>
            </div>
            <div id="portfolioSummary" style="font-size: 22px; color: #2c3e50; font-weight: 500;"></div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="price-mode-btn active" id="prevCloseBtn" onclick="loadPrevCloseMode()">ğŸ“Š ì „ì¼ ì¢…ê°€</button>
            <button class="price-mode-btn" id="realtimeBtn" onclick="loadRealtimeMode()">ğŸ”„ ì‹¤ì‹œê°„ ì¡°íšŒ</button>
            <button class="refresh-btn" onclick="window.open('https://docs.google.com/spreadsheets/d/1AMJsDNUm0y_tFNC3zW3zbWPqFTovEyAl-cnhPnSokSo/edit?gid=0#gid=0', '_blank')">ğŸ“ ì‹œíŠ¸ ì—´ê¸°</button>
            <button class="refresh-btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>
    
    <div class="container">
        <!-- ì¢Œì¸¡ íŒ¨ë„ -->
        <div class="left-panel">
            <div class="panel">
                <div class="accounts-container" id="accountsContainer"></div>
            </div>
            
            <div class="panel trade-history">
                <div class="trade-history-title" id="tradeHistoryTitle">ì¢…ëª©ë³„ ê±°ë˜ ë‚´ì—­</div>
                <div class="trade-history-profit" id="tradeHistoryProfit"></div>
                <div id="tradeHistoryContainer"></div>
            </div>
        </div>
        
        <!-- ìš°ì¸¡ íŒ¨ë„ -->
        <div class="right-panel">
            <div class="panel calendar-section">
                <div class="calendar-header">
                    <button class="filter-btn active" id="allFilterBtn" onclick="selectFilter('all')">ì „ì²´</button>
                    <div class="date-selector">
                        <button class="month-nav-btn" onclick="prevMonth()">â—€</button>
                        <select id="yearSelect" onchange="updateCalendar()"></select>
                        <select id="monthSelect" onchange="updateCalendar()"></select>
                        <button class="month-nav-btn" onclick="nextMonth()">â–¶</button>
                    </div>
                </div>
                
                <div class="current-stock-name" id="currentStockName">ì „ì²´</div>
                
                <div class="calendar">
                    <div class="calendar-grid">
                        <div class="calendar-day-header">ì¼</div>
                        <div class="calendar-day-header">ì›”</div>
                        <div class="calendar-day-header">í™”</div>
                        <div class="calendar-day-header">ìˆ˜</div>
                        <div class="calendar-day-header">ëª©</div>
                        <div class="calendar-day-header">ê¸ˆ</div>
                        <div class="calendar-day-header">í† </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
                
                <div class="calendar-summary">
                    <div class="summary-item">
                        <div class="summary-label">ì´ ë§¤ìˆ˜ì•¡</div>
                        <div class="summary-value profit-positive" id="totalBuy">0ì›</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ì´ ë§¤ë„ì•¡</div>
                        <div class="summary-value profit-negative" id="totalSell">0ì›</div>
                    </div>
                </div>
            </div>
            
            <!-- íƒ­ ì˜ì—­ -->
            <div class="panel tab-section">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('chart')">ì°¨íŠ¸</button>
                    <button class="tab-btn" onclick="switchTab('price')">ì£¼ê°€</button>
                    <button class="tab-btn" onclick="switchTab('diary')">ì¼ê¸°</button>
                </div>
                
                <!-- íƒ­ 1: ë„ë„› ì°¨íŠ¸ -->
                <div class="tab-content active" id="chartTab">
                    <div class="donut-charts-container">
                        <div class="donut-chart-item">
                            <div class="donut-chart-title">ì¢…ëª©</div>
                            <div class="donut-chart-canvas">
                                <canvas id="stockDonutChart"></canvas>
                            </div>
                        </div>
                        <div class="donut-chart-item">
                            <div class="donut-chart-title">ETF</div>
                            <div class="donut-chart-canvas">
                                <canvas id="etfDonutChart"></canvas>
                            </div>
                        </div>
                        <div class="donut-chart-item">
                            <div class="donut-chart-title">ë¯¸êµ­</div>
                            <div class="donut-chart-canvas">
                                <canvas id="usDonutChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- íƒ­ 2: ì£¼ê°€ ì°¨íŠ¸ -->
                <div class="tab-content" id="priceTab">
                    <div class="loading">ì£¼ê°€ ì°¨íŠ¸ ê¸°ëŠ¥ì€<br>ê°œë°œ ì¤‘ì…ë‹ˆë‹¤</div>
                </div>
                
                <!-- íƒ­ 3: ë§¤ë§¤ì¼ê¸° -->
                <div class="tab-content" id="diaryTab">
                    <div class="diary-content">
                        <textarea class="diary-textarea" id="diaryTextarea" oninput="checkDiaryChanged()" placeholder="ì„ íƒí•œ ë‚ ì§œì˜ ì¼ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
                        <button class="diary-save-btn" onclick="saveDiary()">ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let tradeData = [];
        let depositData = { ì¢…í•©: 0, ETF: 0, ë¯¸êµ­: 0, í™˜ìœ¨: 0, í™˜ìœ¨ë‚ ì§œ: '' };  // ì˜ˆìˆ˜ê¸ˆ ë°ì´í„°
        let selectedStock = null;
        let selectedDate = null;
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let stockChart = null;
        let etfChart = null;
        let usChart = null;
        let unsavedDiary = false;  // ì €ì¥ ì•ˆ ëœ ì¼ê¸° ì—¬ë¶€
        let lastDiaryContent = '';  // ë§ˆì§€ë§‰ ë¡œë“œëœ ì¼ê¸° ë‚´ìš©
        
        const SHEET_ID = '1AMJsDNUm0y_tFNC3zW3zbWPqFTovEyAl-cnhPnSokSo';
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQnvayNXW-vM8MpG490_EmlbwJWb7d5sWshz6W_YK4zrBMb1vNKLiOZK254phq-cgofWhZ8a45NxlZ/pub?gid=0&single=true&output=csv';
        const DEPOSIT_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQnvayNXW-vM8MpG490_EmlbwJWb7d5sWshz6W_YK4zrBMb1vNKLiOZK254phq-cgofWhZ8a45NxlZ/pub?gid=2081265323&single=true&output=csv';
        
        // Apps Script ì›¹ ì•± URL
        const DIARY_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWuurYz_PEhuK90Pccl_k8vTZk_lvHxmgy8orGwsHTxdz0YyV21SbWUMAhKWClfDK23Q/exec';
        
        // Vercel API URL
        const VERCEL_API_URL = 'https://mystock-lyart.vercel.app/api/trigger-update';
        
        // ì´ˆê¸°í™”
        async function init() {
            initDateSelectors();
            await loadData();
        }
        
        // ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™”
        function initDateSelectors() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            
            for (let y = 2020; y <= 2030; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y + 'ë…„';
                if (y === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            for (let m = 1; m <= 12; m++) {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m + 'ì›”';
                if (m === currentMonth) option.selected = true;
                monthSelect.appendChild(option);
            }
        }
        
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'chart') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('chartTab').classList.add('active');
            } else if (tabName === 'price') {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('priceTab').classList.add('active');
            } else if (tabName === 'diary') {
                document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
                document.getElementById('diaryTab').classList.add('active');
                loadDiary();
            }
        }
        
        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                console.log('ë°ì´í„° ë¡œë”© ì‹œì‘...');
                const response = await fetch(SHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                tradeData = parseCSV(csvText);
                
                if (tradeData.length === 0) {
                    alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                console.log('ì´ ê±°ë˜ ë°ì´í„°:', tradeData.length, 'ê°œ');
                
                await loadPrevClosePrices();
                await loadDiaryData();
                await loadDepositData();  // ì˜ˆìˆ˜ê¸ˆ ë°ì´í„° ë¡œë“œ
                
                renderAccounts();
                updateCalendar();
                renderDonutCharts();
                updatePortfolioSummary();  // í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½ ì—…ë°ì´íŠ¸
                
                document.getElementById('prevCloseBtn').classList.add('active');
                document.getElementById('realtimeBtn').classList.remove('active');
                
                console.log('ë°ì´í„° ë¡œë”© ì™„ë£Œ!');
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì¼ê¸° ë°ì´í„° ë¡œë“œ
        let diaryData = {};
        
        async function loadDiaryData() {
            const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQnvayNXW-vM8MpG490_EmlbwJWb7d5sWshz6W_YK4zrBMb1vNKLiOZK254phq-cgofWhZ8a45NxlZ/pub?gid=744555707&single=true&output=csv';
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                
                diaryData = {};
                
                // CSVë¥¼ ì¤„ë°”ê¿ˆ í¬í•¨í•´ì„œ íŒŒì‹±
                let inQuotes = false;
                let currentRow = [];
                let currentCell = '';
                
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const nextChar = text[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // ë‘ ê°œì˜ ë”°ì˜´í‘œëŠ” í•˜ë‚˜ì˜ ë”°ì˜´í‘œë¡œ
                            currentCell += '"';
                            i++; // ë‹¤ìŒ ë”°ì˜´í‘œ ê±´ë„ˆë›°ê¸°
                        } else {
                            // ë”°ì˜´í‘œ ì‹œì‘/ë
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // ì…€ êµ¬ë¶„
                        currentRow.push(currentCell);
                        currentCell = '';
                    } else if (char === '\n' && !inQuotes) {
                        // í–‰ êµ¬ë¶„
                        currentRow.push(currentCell);
                        
                        // ì²« í–‰(í—¤ë”)ì´ ì•„ë‹ˆê³ , ìµœì†Œ 2ê°œ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´
                        if (currentRow.length >= 2 && currentRow[0] !== 'ë‚ ì§œ') {
                            const dateStr = currentRow[0].trim();
                            const content = currentRow[1]; // trim í•˜ì§€ ì•ŠìŒ (ê³µë°± ìœ ì§€)
                            if (dateStr && content) {
                                diaryData[dateStr] = content;
                            }
                        }
                        
                        currentRow = [];
                        currentCell = '';
                    } else {
                        currentCell += char;
                    }
                }
                
                // ë§ˆì§€ë§‰ í–‰ ì²˜ë¦¬
                if (currentCell || currentRow.length > 0) {
                    currentRow.push(currentCell);
                    if (currentRow.length >= 2 && currentRow[0] !== 'ë‚ ì§œ') {
                        const dateStr = currentRow[0].trim();
                        const content = currentRow[1];
                        if (dateStr && content) {
                            diaryData[dateStr] = content;
                        }
                    }
                }
                
                console.log('ì¼ê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', Object.keys(diaryData).length + 'ê±´');
            } catch (error) {
                console.error('ì¼ê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ì˜ˆìˆ˜ê¸ˆ ë°ì´í„° ë¡œë“œ
        async function loadDepositData() {
            try {
                const response = await fetch(DEPOSIT_URL);
                const text = await response.text();
                const lines = text.trim().split('\n');
                
                // 14ë²ˆì§¸ í–‰ (index 13)
                if (lines.length >= 14) {
                    const line = lines[13];
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.replace(/^"|"$/g, '').trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.replace(/^"|"$/g, '').trim());
                    
                    // H14(7), I14(8), J14(9), K14(10), A14(0) ì¶”ì¶œ
                    depositData.ì¢…í•© = parseFloat(values[7]?.replace(/,/g, '') || 0);
                    depositData.ETF = parseFloat(values[8]?.replace(/,/g, '') || 0);
                    depositData.ë¯¸êµ­ = parseFloat(values[9]?.replace(/,/g, '') || 0);
                    depositData.í™˜ìœ¨ = parseFloat(values[10]?.replace(/,/g, '') || 0);
                    depositData.í™˜ìœ¨ë‚ ì§œ = values[0] || '';  // A14: ë‚ ì§œ
                    
                    console.log('ì˜ˆìˆ˜ê¸ˆ ë°ì´í„° ë¡œë“œ:', depositData);
                }
            } catch (error) {
                console.error('ì˜ˆìˆ˜ê¸ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // í¬íŠ¸í´ë¦¬ì˜¤ ì „ì²´ ìš”ì•½ ì—…ë°ì´íŠ¸
        function updatePortfolioSummary() {
            let totalInvestment = 0;  // ì´ íˆ¬ìê¸ˆ (ë§¤ìˆ˜ - ë§¤ë„)
            let totalValue = 0;       // ì´ í‰ê°€ê¸ˆì•¡
            
            const accounts = {};
            
            tradeData.forEach(trade => {
                if (!accounts[trade.account]) {
                    accounts[trade.account] = {};
                }
                
                if (!accounts[trade.account][trade.stockName]) {
                    accounts[trade.account][trade.stockName] = {
                        quantity: 0,
                        totalBuy: 0,
                        buyCount: 0,
                        prevClose: trade.prevClose
                    };
                }
                
                const stock = accounts[trade.account][trade.stockName];
                
                if (trade.type === 'ë§¤ìˆ˜') {
                    stock.quantity += trade.quantity;
                    stock.totalBuy += trade.price * trade.quantity;
                    stock.buyCount += trade.quantity;
                    totalInvestment += trade.price * trade.quantity;
                } else if (trade.type === 'ë§¤ë„') {
                    const currentAvgPrice = stock.totalBuy / stock.buyCount;
                    stock.quantity -= trade.quantity;
                    stock.totalBuy -= currentAvgPrice * trade.quantity;
                    stock.buyCount -= trade.quantity;
                    totalInvestment -= trade.price * trade.quantity;
                }
            });
            
            // ì´ í‰ê°€ê¸ˆì•¡ ê³„ì‚°
            Object.keys(accounts).forEach(accountName => {
                Object.keys(accounts[accountName]).forEach(stockName => {
                    const stock = accounts[accountName][stockName];
                    if (stock.quantity > 0) {
                        totalValue += stock.prevClose * stock.quantity;
                    }
                });
            });
            
            const profit = totalValue - totalInvestment;
            const profitRate = totalInvestment !== 0 ? (profit / totalInvestment * 100) : 0;
            const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
            const profitSign = profit >= 0 ? '+' : '';
            
            // í—¤ë”ì— í‘œì‹œ
            const summary = `
                ì´ íˆ¬ì: ${Math.floor(totalInvestment).toLocaleString()}ì› | 
                í‰ê°€ì•¡: ${Math.floor(totalValue).toLocaleString()}ì› | 
                <span class="${profitClass}">${profitSign}${Math.floor(profit).toLocaleString()}ì› (${profitSign}${profitRate.toFixed(2)}%)</span>
            `;
            
            document.getElementById('portfolioSummary').innerHTML = summary;
        }
        
        // CSV íŒŒì‹±
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                if (values.length < 9) continue;
                
                const account = values[2]?.replace(/"/g, '').trim();
                const priceIndex = account === 'ë¯¸êµ­' ? 9 : 8;  // ğŸ‘ˆ ë¯¸êµ­ì´ë©´ 9ë²ˆì§¸, ì•„ë‹ˆë©´ 8ë²ˆì§¸
                
                const row = {
                    date: values[0]?.replace(/"/g, '').trim(),
                    account: account,
                    category: values[3]?.replace(/"/g, '').trim(),
                    stockName: values[4]?.replace(/"/g, '').trim(),
                    code: values[5]?.replace(/"/g, '').trim(),
                    type: values[6]?.replace(/"/g, '').trim(),
                    quantity: parseInt(values[7]?.replace(/"/g, '').replace(/,/g, '')) || 0,
                    price: parseFloat(values[priceIndex]?.replace(/"/g, '').replace(/,/g, '')) || 0,  // ğŸ‘ˆ ìˆ˜ì •
                    prevClose: 0
                };
                
                // ë‚ ì§œ í˜•ì‹ ë³€í™˜
                if (row.date && row.date.includes('.')) {
                    const parts = row.date.split('.');
                    if (parts.length === 3) {
                        const year = parts[0].length === 2 ? '20' + parts[0] : parts[0];
                        const month = parts[1].padStart(2, '0');
                        const day = parts[2].padStart(2, '0');
                        row.date = `${year}-${month}-${day}`;
                    }
                }
                
                if (row.stockName && row.date) {
                    data.push(row);
                }
            }
            
            return data;
        }
        
        // ì „ì¼ ì¢…ê°€ ë¡œë“œ
        async function loadPrevClosePrices() {
            try {
                // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                const timestamp = new Date().getTime();
                const response = await fetch(`stock_prices.json?t=${timestamp}`);
                if (!response.ok) throw new Error('íŒŒì¼ ì—†ìŒ');
                
                const data = await response.json();
                
                console.log('ğŸ“Š ê°€ê²© ë°ì´í„° ë¡œë“œ:', data.updated_at);
                
                // í—¤ë”ì— ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ (í•œêµ­ ì‹œê°„)
                if (data.updated_at) {
                    // ISO ë¬¸ìì—´ ì§ì ‘ íŒŒì‹± (ì˜ˆ: "2026-01-27T11:13:59.475851")
                    const isoString = data.updated_at;
                    
                    // UTC ê¸°ì¤€ìœ¼ë¡œ Date ê°ì²´ ìƒì„± (Z ë¶™ì—¬ì„œ ê°•ì œ UTC)
                    const utcDate = new Date(isoString.endsWith('Z') ? isoString : isoString + 'Z');
                    
                    // í•œêµ­ ì‹œê°„ = UTC + 9ì‹œê°„
                    const kstOffset = 9 * 60 * 60 * 1000;
                    const kstDate = new Date(utcDate.getTime() + kstOffset);
                    
                    const month = kstDate.getUTCMonth() + 1;
                    const day = kstDate.getUTCDate();
                    const hours = String(kstDate.getUTCHours()).padStart(2, '0');
                    const minutes = String(kstDate.getUTCMinutes()).padStart(2, '0');
                    
                    console.log('ì‹œê°„ ë³€í™˜:', {
                        original: isoString,
                        utc: utcDate.toISOString(),
                        kst: `${month}ì›” ${day}ì¼ ${hours}:${minutes}`
                    });
                    
                    document.getElementById('priceUpdateTime').textContent = 
                        `(ì „ì¼ ì¢…ê°€: ${month}ì›” ${day}ì¼ ${hours}:${minutes} ê¸°ì¤€)`;
                }
                
                tradeData.forEach(trade => {
                    if (data.prices && data.prices[trade.code]) {
                        trade.prevClose = data.prices[trade.code];
                    } else {
                        trade.prevClose = trade.price * 0.98;
                    }
                });
                
                console.log('âœ… ì „ì¼ ì¢…ê°€ ì ìš© ì™„ë£Œ');
            } catch (error) {
                console.log('âš ï¸ stock_prices.json ì—†ìŒ - ë§¤ìˆ˜ê°€ ê¸°ì¤€ ì‚¬ìš©');
                document.getElementById('priceUpdateTime').textContent = '';
                tradeData.forEach(trade => {
                    trade.prevClose = trade.price;
                });
            }
        }
        
        // ì‹¤ì‹œê°„ ì£¼ê°€ ê°€ì ¸ì˜¤ê¸°
        async function fetchRealtimePrices() {
            console.log('ğŸ”„ ì‹¤ì‹œê°„ ì£¼ê°€ ì¡°íšŒ ì‹œì‘...');
            
            const codes = [...new Set(tradeData.map(t => t.code))];
            let successCount = 0;
            let failCount = 0;
            
            for (const code of codes) {
                try {
                    const exchange = code.startsWith('0') ? 'KQ' : 'KS';
                    const symbol = `${code}.${exchange}`;
                    
                    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data['Global Quote'] && data['Global Quote']['05. price']) {
                        const price = parseFloat(data['Global Quote']['05. price']);
                        
                        tradeData.forEach(trade => {
                            if (trade.code === code) {
                                trade.prevClose = price;
                            }
                        });
                        
                        successCount++;
                        console.log(`âœ… ${code}: ${price}ì›`);
                    } else {
                        failCount++;
                        console.warn(`âš ï¸ ${code}: ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨ (ì „ì¼ ì¢…ê°€ ì‚¬ìš©)`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    failCount++;
                    console.error(`âŒ ${code} ì¡°íšŒ ì˜¤ë¥˜ (ì „ì¼ ì¢…ê°€ ì‚¬ìš©):`, error.message);
                }
            }
            
            console.log(`ğŸ“Š ì‹¤ì‹œê°„ ì¡°íšŒ ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ`);
            
            if (successCount === 0) {
                console.log('âš ï¸ ì‹¤ì‹œê°„ ì¡°íšŒ ì „ì²´ ì‹¤íŒ¨ - stock_prices.jsonì˜ ì „ì¼ ì¢…ê°€ ì‚¬ìš©');
            }
            
            return successCount;
        }
        
        // ì „ì¼ ì¢…ê°€ ëª¨ë“œ
        async function loadPrevCloseMode() {
            const btn = document.getElementById('prevCloseBtn');
            const realtimeBtn = document.getElementById('realtimeBtn');
            
            btn.classList.add('active');
            realtimeBtn.classList.remove('active');
            
            console.log('ğŸ“Š ì „ì¼ ì¢…ê°€ ëª¨ë“œ');
            await loadPrevClosePrices();
            renderAccounts();
            updateCalendar();
            renderDonutCharts();
        }
        
        // ì‹¤ì‹œê°„ ì¡°íšŒ ëª¨ë“œ - GitHub Actions íŠ¸ë¦¬ê±°
        async function loadRealtimeMode() {
            const btn = document.getElementById('realtimeBtn');
            const prevCloseBtn = document.getElementById('prevCloseBtn');
            
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ ì£¼ê°€ ì—…ë°ì´íŠ¸ ì¤‘...';
            prevCloseBtn.classList.remove('active');
            
            try {
                console.log('ğŸ”„ GitHub Actions íŠ¸ë¦¬ê±° ì‹œì‘...');
                
                const response = await fetch(VERCEL_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('ì‘ë‹µ ë°ì´í„°:', data);
                
                if (data.success) {
                    console.log('âœ… ì—…ë°ì´íŠ¸ ì‹œì‘:', data.message);
                    btn.textContent = 'â³ ì²˜ë¦¬ ì¤‘... (1-2ë¶„ ì†Œìš”)';
                    btn.classList.add('active');
                    
                    // 2ë¶„ í›„ ìë™ìœ¼ë¡œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    setTimeout(async () => {
                        console.log('ğŸ”„ ìµœì‹  ë°ì´í„° ë¡œë“œ ì¤‘...');
                        
                        await loadPrevClosePrices();
                        renderAccounts();
                        updateCalendar();
                        renderDonutCharts();
                        
                        alert('âœ… ì£¼ê°€ ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
                        btn.textContent = 'ğŸ”„ ì‹¤ì‹œê°„ ì¡°íšŒ';
                        btn.disabled = false;
                    }, 120000); // 2ë¶„
                    
                } else {
                    throw new Error(data.error || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('ì˜¤ë¥˜:', error);
                alert('ì£¼ê°€ ì—…ë°ì´íŠ¸ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                btn.textContent = 'ğŸ”„ ì‹¤ì‹œê°„ ì¡°íšŒ';
                btn.disabled = false;
            }
        }
        
        // ê³„ì¢Œ í˜„í™© ë Œë”ë§
        function renderAccounts() {
            const container = document.getElementById('accountsContainer');
            const accounts = {};
            
            tradeData.forEach(trade => {
                if (!accounts[trade.account]) {
                    accounts[trade.account] = {};
                }
                if (!accounts[trade.account][trade.stockName]) {
                    accounts[trade.account][trade.stockName] = {
                        quantity: 0,
                        totalBuy: 0,
                        buyCount: 0,
                        code: trade.code,
                        prevClose: trade.prevClose,
                        category: trade.category
                    };
                }
                
                const stock = accounts[trade.account][trade.stockName];
                
                if (trade.type === 'ë§¤ìˆ˜') {
                    stock.quantity += trade.quantity;
                    stock.totalBuy += trade.price * trade.quantity;
                    stock.buyCount += trade.quantity;
                } else if (trade.type === 'ë§¤ë„') {
                    const currentAvgPrice = stock.totalBuy / stock.buyCount;
                    stock.quantity -= trade.quantity;
                    stock.totalBuy -= currentAvgPrice * trade.quantity;
                    stock.buyCount -= trade.quantity;
                }
            });
            
            // ê³„ì¢Œ ìˆœì„œ: ì¢…ëª©, ETF, ë¯¸êµ­
            const accountOrder = ['ì¢…ëª©', 'ETF', 'ë¯¸êµ­'];
            let html = '';
            
            accountOrder.forEach(accountName => {
                if (!accounts[accountName]) return;
                
                // ì˜ˆìˆ˜ê¸ˆ í‘œì‹œ
                let depositText = '';
                if (accountName === 'ì¢…í•©') {
                    depositText = `<span style="font-size: 14px; color: #7f8c8d; margin-left: 10px;">ì˜ˆìˆ˜ê¸ˆ: ${depositData.ì¢…í•©.toLocaleString()}ì›</span>`;
                } else if (accountName === 'ETF') {
                    depositText = `<span style="font-size: 14px; color: #7f8c8d; margin-left: 10px;">ì˜ˆìˆ˜ê¸ˆ: ${depositData.ETF.toLocaleString()}ì›</span>`;
                } else if (accountName === 'ë¯¸êµ­') {
                    const rateInfo = depositData.í™˜ìœ¨ > 0 ? ` (í™˜ìœ¨ 1$=${depositData.í™˜ìœ¨.toLocaleString()}ì›, ${depositData.í™˜ìœ¨ë‚ ì§œ} ê¸°ì¤€)` : '';
                    depositText = `<span style="font-size: 14px; color: #7f8c8d; margin-left: 10px;">ì˜ˆìˆ˜ê¸ˆ: $${depositData.ë¯¸êµ­.toLocaleString()}${rateInfo}</span>`;
                }
                
                html += `<div class="account-section">`;
                html += `<div class="account-title">${accountName}${depositText}</div>`;
                
                // ì¢…ëª©ì„ í‰ê°€ê¸ˆì•¡ ìˆœìœ¼ë¡œ ì •ë ¬
                const stockList = Object.keys(accounts[accountName])
                    .map(stockName => ({
                        name: stockName,
                        data: accounts[accountName][stockName]
                    }))
                    .filter(item => item.data.quantity > 0)
                    .sort((a, b) => {
                        const valueA = a.data.prevClose * a.data.quantity;
                        const valueB = b.data.prevClose * b.data.quantity;
                        return valueB - valueA;
                    });
                
                stockList.forEach(item => {
                    const stockName = item.name;
                    const stock = item.data;
                    
                    const avgPrice = stock.totalBuy / stock.buyCount;
                    const currentValue = stock.prevClose * stock.quantity;
                    const profit = currentValue - (avgPrice * stock.quantity);
                    const profitRate = (profit / (avgPrice * stock.quantity) * 100).toFixed(2);
                    const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
                    
                    // ë¯¸êµ­ ê³„ì¢Œ ì—¬ë¶€ í™•ì¸
                    const isUS = accountName === 'ë¯¸êµ­';
                    const currency = isUS ? '$' : 'ì›';
                    const priceFormat = (price) => {
                        if (isUS) {
                            return '$' + price.toFixed(2);
                        } else {
                            return Math.floor(price).toLocaleString() + 'ì›';
                        }
                    };
                    
                    html += `
                        <div class="stock-item" onclick="selectStock('${stockName}', '${stock.code}')">
                            <div class="stock-name">
                                ${stockName} 
                                <span class="${profitClass}" style="font-size: 19px;">(${profitRate >= 0 ? '+' : ''}${profitRate}%)</span>
                            </div>
                            
                            <div class="stock-info stock-info-label" style="margin-top: 8px;">
                                <div>ë³´ìœ ìˆ˜ëŸ‰</div>
                                <div>í‰ê· ë‹¨ê°€</div>
                                <div>ì „ì¼ì¢…ê°€</div>
                            </div>
                            
                            <div class="stock-info" style="margin-bottom: 8px;">
                                <div>${stock.quantity}ì£¼</div>
                                <div>${priceFormat(avgPrice)}</div>
                                <div>${priceFormat(stock.prevClose)}</div>
                            </div>
                            
                            <div class="stock-info stock-info-label">
                                <div>ìˆ˜ìµë¥ </div>
                                <div>í‰ê°€ì†ìµ</div>
                                <div>í‰ê°€ê¸ˆì•¡</div>
                            </div>
                            
                            <div class="stock-info">
                                <div class="${profitClass}">${profitRate >= 0 ? '+' : ''}${profitRate}%</div>
                                <div class="${profitClass}">${profit >= 0 ? '+' : ''}${priceFormat(Math.abs(profit))}</div>
                                <div>${priceFormat(currentValue)}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // ë„ë„› ì°¨íŠ¸ ë Œë”ë§
        function renderDonutCharts() {
            const categoryData = {};
            
            // ê³„ì¢Œë³„ë¡œ êµ¬ë¶„í•˜ì—¬ ë°ì´í„° ì§‘ê³„
            tradeData.forEach(trade => {
                if (!categoryData[trade.account]) {
                    categoryData[trade.account] = {};
                }
                
                const category = trade.category || 'ê¸°íƒ€';
                
                if (!categoryData[trade.account][category]) {
                    categoryData[trade.account][category] = {
                        stocks: {}
                    };
                }
                
                if (!categoryData[trade.account][category].stocks[trade.stockName]) {
                    categoryData[trade.account][category].stocks[trade.stockName] = {
                        quantity: 0,
                        totalBuy: 0,
                        buyCount: 0,
                        code: trade.code,
                        prevClose: trade.prevClose
                    };
                }
                
                const stock = categoryData[trade.account][category].stocks[trade.stockName];
                
                if (trade.type === 'ë§¤ìˆ˜') {
                    stock.quantity += trade.quantity;
                    stock.totalBuy += trade.price * trade.quantity;
                    stock.buyCount += trade.quantity;
                } else if (trade.type === 'ë§¤ë„') {
                    const currentAvgPrice = stock.totalBuy / stock.buyCount;
                    stock.quantity -= trade.quantity;
                    stock.totalBuy -= currentAvgPrice * trade.quantity;
                    stock.buyCount -= trade.quantity;
                }
            });
            
            // ìƒ‰ìƒ ë§¤í•‘
            const colorMap = {
                'ì§€ìˆ˜': '#FF6384',
                'AI': '#36A2EB',
                'ë°˜ë„ì²´': '#FFCE56',
                'ë°©ì‚°': '#4BC0C0',
                'ì¡°ì„ ': '#9966FF',
                'ë°©ì–´': '#95A5A6',  /* ğŸ‘ˆ íšŒìƒ‰ */
                'ì „ë ¥': '#E67E22',  /* ğŸ‘ˆ ì£¼í™©ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
                'ê¸ˆ': '#FFD700',      /* ğŸ‘ˆ ê¸ˆìƒ‰ */
                'ì€': '#C0C0C0',      /* ğŸ‘ˆ ì€ìƒ‰ */
                'ìš°ë¼ëŠ„': '#1E90FF',
                'ê¸°íƒ€': '#FF9F40'
            };
            
            // ê³µí†µ ì°¨íŠ¸ ì˜µì…˜
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 21,
                            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif'
                        },
                        bodyFont: {
                            size: 19,
                            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif'
                        },
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                
                                // ë¯¸êµ­ ì°¨íŠ¸ì¸ì§€ í™•ì¸
                                const isUS = context.chart.canvas.id === 'usDonutChart';
                                
                                if (isUS) {
                                    return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                } else {
                                    return `${label}: ${Math.floor(value).toLocaleString()}ì› (${percentage}%)`;
                                }
                            }
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 19
                        },
                        formatter: (value, ctx) => {
                            return ctx.chart.data.labels[ctx.dataIndex];
                        }
                    }
                }
            };
            
            // ì¢…ëª© ì°¨íŠ¸
            const stockCategories = categoryData['ì¢…ëª©'] || {};
            const stockLabels = [];
            const stockValues = [];
            const stockColors = [];
            
            Object.keys(stockCategories).forEach(category => {
                let totalValue = 0;
                Object.values(stockCategories[category].stocks).forEach(stock => {
                    if (stock.quantity > 0) {
                        totalValue += stock.prevClose * stock.quantity;
                    }
                });
                if (totalValue > 0) {
                    stockLabels.push(category);
                    stockValues.push(totalValue);
                    stockColors.push(colorMap[category] || '#95A5A6');
                }
            });
            
            const stockCtx = document.getElementById('stockDonutChart').getContext('2d');
            if (stockChart) {
                stockChart.destroy();
            }
            
            Chart.register(ChartDataLabels);
            
            stockChart = new Chart(stockCtx, {
                type: 'doughnut',
                data: {
                    labels: stockLabels,
                    datasets: [{
                        data: stockValues,
                        backgroundColor: stockColors
                    }]
                },
                options: commonOptions
            });
            
            // ETF ì°¨íŠ¸
            const etfCategories = categoryData['ETF'] || {};
            const etfLabels = [];
            const etfValues = [];
            const etfColors = [];
            
            Object.keys(etfCategories).forEach(category => {
                let totalValue = 0;
                Object.values(etfCategories[category].stocks).forEach(stock => {
                    if (stock.quantity > 0) {
                        totalValue += stock.prevClose * stock.quantity;
                    }
                });
                if (totalValue > 0) {
                    etfLabels.push(category);
                    etfValues.push(totalValue);
                    etfColors.push(colorMap[category] || '#95A5A6');
                }
            });
            
            const etfCtx = document.getElementById('etfDonutChart').getContext('2d');
            if (etfChart) {
                etfChart.destroy();
            }
            etfChart = new Chart(etfCtx, {
                type: 'doughnut',
                data: {
                    labels: etfLabels,
                    datasets: [{
                        data: etfValues,
                        backgroundColor: etfColors
                    }]
                },
                options: commonOptions
            });
            
            // ë¯¸êµ­ ì°¨íŠ¸
            const usCategories = categoryData['ë¯¸êµ­'] || {};
            const usLabels = [];
            const usValues = [];
            const usColors = [];
            
            Object.keys(usCategories).forEach(category => {
                let totalValue = 0;
                Object.values(usCategories[category].stocks).forEach(stock => {
                    if (stock.quantity > 0) {
                        totalValue += stock.prevClose * stock.quantity;
                    }
                });
                if (totalValue > 0) {
                    usLabels.push(category);
                    usValues.push(totalValue);
                    usColors.push(colorMap[category] || '#95A5A6');
                }
            });
            
            const usCtx = document.getElementById('usDonutChart').getContext('2d');
            if (usChart) {
                usChart.destroy();
            }
            usChart = new Chart(usCtx, {
                type: 'doughnut',
                data: {
                    labels: usLabels,
                    datasets: [{
                        data: usValues,
                        backgroundColor: usColors
                    }]
                },
                options: commonOptions
            });
        }
        
        // ì¢…ëª© ì„ íƒ
        function selectStock(stockName, code) {
            selectedStock = stockName;
            selectedDate = null;
            
            // ì¢…ëª© í™œì„±í™”, ë‚ ì§œ ë¹„í™œì„±í™”
            document.querySelectorAll('.stock-item').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.stock-item').classList.add('active');
            
            document.querySelectorAll('.calendar-day').forEach(el => {
                el.classList.remove('active');
            });
            
            document.getElementById('currentStockName').textContent = stockName;
            document.getElementById('allFilterBtn').classList.remove('active');
            
            renderStockHistory(stockName);
            updateCalendar();
        }
        
        // ì „ì²´ í•„í„° ì„ íƒ
        function selectFilter(filter) {
            if (filter === 'all') {
                selectedStock = null;
                selectedDate = null;
                
                document.getElementById('currentStockName').textContent = 'ì „ì²´';
                document.getElementById('allFilterBtn').classList.add('active');
                
                document.querySelectorAll('.stock-item').forEach(el => {
                    el.classList.remove('active');
                });
                document.querySelectorAll('.calendar-day').forEach(el => {
                    el.classList.remove('active');
                });
                
                document.getElementById('tradeHistoryContainer').innerHTML = '';
                document.getElementById('tradeHistoryProfit').innerHTML = '';
                document.getElementById('tradeHistoryTitle').textContent = 'ì¢…ëª©ë³„ ê±°ë˜ ë‚´ì—­';
                
                updateCalendar();
            }
        }
        
        // ì¢…ëª©ë³„ ê±°ë˜ ë‚´ì—­ ë Œë”ë§
        function renderStockHistory(stockName) {
            const container = document.getElementById('tradeHistoryContainer');
            const trades = tradeData.filter(t => t.stockName === stockName);
            
            let totalBuy = 0, totalSell = 0;
            let totalBuyAmount = 0, totalSellAmount = 0;
            
            // ê³„ì¢Œë³„ ë§¤ìˆ˜/ë§¤ë„ ìˆ˜ëŸ‰ ì§‘ê³„
            const buyByAccount = {};
            const sellByAccount = {};
            
            trades.forEach(trade => {
                if (trade.type === 'ë§¤ìˆ˜') {
                    totalBuy += trade.quantity;
                    totalBuyAmount += trade.price * trade.quantity;
                    buyByAccount[trade.account] = (buyByAccount[trade.account] || 0) + trade.quantity;
                } else {
                    totalSell += trade.quantity;
                    totalSellAmount += trade.price * trade.quantity;
                    sellByAccount[trade.account] = (sellByAccount[trade.account] || 0) + trade.quantity;
                }
            });
            
            const holding = totalBuy - totalSell;
            
            // ê³„ì¢Œë³„ ì •ë³´ ë¬¸ìì—´ ìƒì„±
            const buyAccountText = Object.keys(buyByAccount)
                .map(acc => `${buyByAccount[acc]}ì£¼(${acc})`)
                .join(', ');
            const sellAccountText = Object.keys(sellByAccount)
                .map(acc => `${sellByAccount[acc]}ì£¼(${acc})`)
                .join(', ');
            
            const avgPrice = totalBuyAmount / totalBuy;
            const firstTrade = trades.find(t => t.prevClose);
            const currentPrice = firstTrade ? firstTrade.prevClose : avgPrice;
            const currentValue = currentPrice * holding;
            const profit = currentValue - (avgPrice * holding);
            const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
            
            // ë¯¸êµ­ ê³„ì¢Œì¸ì§€ í™•ì¸
            const isUS = firstTrade && firstTrade.account === 'ë¯¸êµ­';
            
            document.getElementById('tradeHistoryTitle').innerHTML = 
                `ì¢…ëª©ë³„ ê±°ë˜ ë‚´ì—­ - ${stockName} (<span style="color: #e74c3c;">ë§¤ìˆ˜ ${buyAccountText}</span> / <span style="color: #3498db;">ë§¤ë„ ${sellAccountText}</span> / <span style="color: #2c3e50;">ë³´ìœ  ${holding}ì£¼</span>)`;
            
            if (isUS) {
                document.getElementById('tradeHistoryProfit').innerHTML = 
                    `í‰ê°€ì†ìµ: <span class="${profitClass}">${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}</span>`;
            } else {
                document.getElementById('tradeHistoryProfit').innerHTML = 
                    `í‰ê°€ì†ìµ: <span class="${profitClass}">${profit >= 0 ? '+' : ''}${Math.floor(profit).toLocaleString()}ì›</span>`;
            }
            
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(5, 1fr)';
            let html = '';
            trades.forEach(trade => {
                const totalAmount = trade.price * trade.quantity;
                const typeClass = trade.type === 'ë§¤ìˆ˜' ? 'buy' : 'sell';
                const itemClass = trade.type === 'ë§¤ìˆ˜' ? 'buy-item' : 'sell-item';
                
                // ë¯¸êµ­ ê³„ì¢Œ ì—¬ë¶€ í™•ì¸
                const tradeIsUS = trade.account === 'ë¯¸êµ­';
                const priceFormat = (price) => {
                    if (tradeIsUS) {
                        return '$' + price.toFixed(2);
                    } else {
                        return Math.floor(price).toLocaleString() + 'ì›';
                    }
                };
                
                html += `
                    <div class="date-trade-detail ${itemClass}">
                        <div>
                            <span class="trade-type-box ${typeClass}">${trade.type}</span>
                            <span class="trade-stock-name">${trade.date}</span>
                        </div>
                        <div class="trade-detail-vertical">
                            <div>ìˆ˜ëŸ‰: <strong>${trade.quantity}ì£¼ (${trade.account})</strong></div>
                            <div>ë‹¨ê°€: <strong>${priceFormat(trade.price)}</strong></div>
                            <div>ì´ì•¡: <strong>${priceFormat(totalAmount)}</strong></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ì´ì „ ë‹¬ë¡œ ì´ë™
        function prevMonth() {
            let year = parseInt(document.getElementById('yearSelect').value);
            let month = parseInt(document.getElementById('monthSelect').value);
            
            month--;
            if (month < 1) {
                month = 12;
                year--;
            }
            
            document.getElementById('yearSelect').value = year;
            document.getElementById('monthSelect').value = month;
            updateCalendar();
        }
        
        // ë‹¤ìŒ ë‹¬ë¡œ ì´ë™
        function nextMonth() {
            let year = parseInt(document.getElementById('yearSelect').value);
            let month = parseInt(document.getElementById('monthSelect').value);
            
            month++;
            if (month > 12) {
                month = 1;
                year++;
            }
            
            document.getElementById('yearSelect').value = year;
            document.getElementById('monthSelect').value = month;
            updateCalendar();
        }
        
        // ë‹¬ë ¥ ì—…ë°ì´íŠ¸
        function updateCalendar() {
            const year = parseInt(document.getElementById('yearSelect').value);
            const month = parseInt(document.getElementById('monthSelect').value);
            currentYear = year;
            currentMonth = month;
            
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div class="calendar-day empty"></div>';
            }
            
            const dailyTrades = {};
            let totalBuy = 0;
            let totalSell = 0;
            const buyByAccount = {};
            const sellByAccount = {};
            
            tradeData.forEach(trade => {
                if (selectedStock && trade.stockName !== selectedStock) return;
                
                const tradeDate = new Date(trade.date);
                if (tradeDate.getFullYear() !== year || tradeDate.getMonth() + 1 !== month) return;
                
                const day = tradeDate.getDate();
                if (!dailyTrades[day]) {
                    dailyTrades[day] = { 
                        buy: 0, 
                        sell: 0, 
                        buyQty: 0, 
                        sellQty: 0,
                        account: trade.account
                    };
                }
                
                const amount = trade.price * trade.quantity;
                if (trade.type === 'ë§¤ìˆ˜') {
                    dailyTrades[day].buy += amount;
                    dailyTrades[day].buyQty += trade.quantity;
                    totalBuy += amount;
                    buyByAccount[trade.account] = (buyByAccount[trade.account] || 0) + amount;
                } else {
                    dailyTrades[day].sell += amount;
                    dailyTrades[day].sellQty += trade.quantity;
                    totalSell += amount;
                    sellByAccount[trade.account] = (sellByAccount[trade.account] || 0) + amount;
                }
            });
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const trades = dailyTrades[day] || { buy: 0, sell: 0, buyQty: 0, sellQty: 0, account: null };
                
                const isUS = trades.account === 'ë¯¸êµ­';
                
                let dayHtml = `
                    <div class="calendar-day${selectedDate === dateStr ? ' active' : ''}" onclick="selectDate('${dateStr}')">
                        <div class="day-number">${day}</div>
                `;
                
                if (trades.buy > 0) {
                    if (isUS) {
                        dayHtml += `<div class="day-buy">ë§¤ìˆ˜ ${trades.buyQty}ì£¼/$${trades.buy.toFixed(2)}</div>`;
                    } else {
                        dayHtml += `<div class="day-buy">ë§¤ìˆ˜ ${trades.buyQty}ì£¼/${(trades.buy/10000).toFixed(1)}ë§Œ</div>`;
                    }
                }
                if (trades.sell > 0) {
                    if (isUS) {
                        dayHtml += `<div class="day-sell">ë§¤ë„ ${trades.sellQty}ì£¼/$${trades.sell.toFixed(2)}</div>`;
                    } else {
                        dayHtml += `<div class="day-sell">ë§¤ë„ ${trades.sellQty}ì£¼/${(trades.sell/10000).toFixed(1)}ë§Œ</div>`;
                    }
                }
                
                dayHtml += `</div>`;
                grid.innerHTML += dayHtml;
            }
            
            // ì´ ë§¤ìˆ˜ì•¡/ë§¤ë„ì•¡ í‘œì‹œ
            const isUSStock = selectedStock && tradeData.find(t => t.stockName === selectedStock)?.account === 'ë¯¸êµ­';
            
            // ì¢…ëª©ì´ë‚˜ ë‚ ì§œë¥¼ ì„ íƒí•œ ê²½ìš° - ê³„ì¢Œëª…ë§Œ í‘œì‹œ
            if (selectedStock || selectedDate) {
                const buyAccountNames = Object.keys(buyByAccount)
                    .filter(acc => buyByAccount[acc] > 0)
                    .join(', ');
                
                const sellAccountNames = Object.keys(sellByAccount)
                    .filter(acc => sellByAccount[acc] > 0)
                    .join(', ');
                
                if (isUSStock) {
                    document.getElementById('totalBuy').textContent = `$${totalBuy.toFixed(2)}` + (buyAccountNames ? ` (${buyAccountNames})` : '');
                    document.getElementById('totalSell').textContent = `$${totalSell.toFixed(2)}` + (sellAccountNames ? ` (${sellAccountNames})` : '');
                } else {
                    document.getElementById('totalBuy').textContent = `${Math.floor(totalBuy).toLocaleString()}ì›` + (buyAccountNames ? ` (${buyAccountNames})` : '');
                    document.getElementById('totalSell').textContent = `${Math.floor(totalSell).toLocaleString()}ì›` + (sellAccountNames ? ` (${sellAccountNames})` : '');
                }
            }
            // ì „ì²´ ì„ íƒ ì‹œ - ê³„ì¢Œë³„ ê¸ˆì•¡ì„ 3ì¤„ë¡œ í‘œì‹œ
            else {
                let buyHtml = '';
                let sellHtml = '';
                
                Object.keys(buyByAccount)
                    .filter(acc => buyByAccount[acc] > 0)
                    .forEach(acc => {
                        if (acc === 'ë¯¸êµ­') {
                            buyHtml += `${acc}: $${buyByAccount[acc].toFixed(2)}<br>`;
                        } else {
                            buyHtml += `${acc}: ${Math.floor(buyByAccount[acc]).toLocaleString()}ì›<br>`;
                        }
                    });
                
                Object.keys(sellByAccount)
                    .filter(acc => sellByAccount[acc] > 0)
                    .forEach(acc => {
                        if (acc === 'ë¯¸êµ­') {
                            sellHtml += `${acc}: $${sellByAccount[acc].toFixed(2)}<br>`;
                        } else {
                            sellHtml += `${acc}: ${Math.floor(sellByAccount[acc]).toLocaleString()}ì›<br>`;
                        }
                    });
                
                document.getElementById('totalBuy').innerHTML = buyHtml || '0ì›';
                document.getElementById('totalSell').innerHTML = sellHtml || '0ì›';
            }
        }
        
        // ë‚ ì§œ ì„ íƒ
        async function selectDate(dateStr) {
            // ì €ì¥ ì•ˆ ëœ ì¼ê¸°ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì €ì¥ í™•ì¸
            if (unsavedDiary && selectedDate) {
                if (confirm('ì €ì¥í•˜ì§€ ì•Šì€ ì¼ê¸°ê°€ ìˆìŠµë‹ˆë‹¤. ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    await saveDiary();
                }
            }
            
            selectedDate = dateStr;
            selectedStock = null;
            
            // ë‚ ì§œ í™œì„±í™”, ì¢…ëª© ë¹„í™œì„±í™”
            document.querySelectorAll('.calendar-day').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.calendar-day').classList.add('active');
            
            document.querySelectorAll('.stock-item').forEach(el => {
                el.classList.remove('active');
            });
            
            renderDateTradeDetails(dateStr);
            await loadDiary();
        }
        
        // ë‚ ì§œë³„ ê±°ë˜ ìƒì„¸ ë Œë”ë§
        function renderDateTradeDetails(dateStr) {
            const container = document.getElementById('tradeHistoryContainer');
            const trades = tradeData.filter(t => t.date === dateStr);
            
            document.getElementById('tradeHistoryTitle').textContent = `ë‚ ì§œ/ê±°ë˜ ìƒì„¸ - ${dateStr}`;
            document.getElementById('tradeHistoryProfit').innerHTML = '';
            
            if (trades.length === 0) {
                container.style.display = 'block';
                container.innerHTML = '<div class="loading" style="padding: 20px;">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            container.style.display = 'grid';  /* ğŸ‘ˆ block â†’ grid */
            container.style.gridTemplateColumns = 'repeat(5, 1fr)';  /* ğŸ‘ˆ ì¶”ê°€ */
            
            let html = '';
            trades.forEach(trade => {
                const typeClass = trade.type === 'ë§¤ìˆ˜' ? 'buy' : 'sell';
                const itemClass = trade.type === 'ë§¤ìˆ˜' ? 'buy-item' : 'sell-item';
                const amount = trade.price * trade.quantity;
                
                // ë¯¸êµ­ ê³„ì¢Œ ì—¬ë¶€ í™•ì¸
                const isUS = trade.account === 'ë¯¸êµ­';
                const priceFormat = (price) => {
                    if (isUS) {
                        return '$' + price.toFixed(2);
                    } else {
                        return Math.floor(price).toLocaleString() + 'ì›';
                    }
                };
                
                html += `
                    <div class="date-trade-detail ${itemClass}">
                        <div>
                            <span class="trade-type-box ${typeClass}">${trade.type}</span>
                            <span class="trade-stock-name">${trade.stockName}</span>
                        </div>
                        <div class="trade-detail-vertical">
                            <div>ìˆ˜ëŸ‰: <strong>${trade.quantity}ì£¼ (${trade.account})</strong></div>
                            <div>ë‹¨ê°€: <strong>${priceFormat(trade.price)}</strong></div>
                            <div>ì´ì•¡: <strong>${priceFormat(amount)}</strong></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ì¼ê¸° ë¡œë“œ
        async function loadDiary() {
            if (!selectedDate) {
                document.getElementById('diaryTextarea').value = '';
                lastDiaryContent = '';
                unsavedDiary = false;
                return;
            }
            
            // ë‚ ì§œ í˜•ì‹ ë³€í™˜: 2026-01-27 â†’ 26.01.27
            let convertedDate = selectedDate;
            if (selectedDate.includes('-')) {
                const parts = selectedDate.split('-');
                const year = parts[0].substring(2);  // 2026 â†’ 26
                const month = parts[1];              // 01
                const day = parts[2];                // 27
                convertedDate = `${year}.${month}.${day}`;  // 26.01.27
            }
            
            // Google Sheetsì—ì„œ ë¶ˆëŸ¬ì˜¨ ì¼ê¸°
            const sheetContent = diaryData[convertedDate] || '';
            
            // localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„ (ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©)
            let content = sheetContent;
            try {
                if (window.storage && window.storage.get) {
                    const result = await window.storage.get(`diary_${selectedDate}`);
                    if (result && result.value) {
                        content = result.value;
                    }
                }
            } catch (error) {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—†ìœ¼ë©´ ì‹œíŠ¸ ë°ì´í„° ì‚¬ìš©
                console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—†ìŒ, ì‹œíŠ¸ ë°ì´í„° ì‚¬ìš©');
            }
            
            document.getElementById('diaryTextarea').value = content;
            lastDiaryContent = content;
            unsavedDiary = false;
        }
        
        // ì¼ê¸° ë‚´ìš© ë³€ê²½ ê°ì§€
        function checkDiaryChanged() {
            const currentContent = document.getElementById('diaryTextarea').value;
            unsavedDiary = (currentContent !== lastDiaryContent);
        }
        
        // ì¼ê¸° ì €ì¥
        async function saveDiary() {
            if (!selectedDate) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const content = document.getElementById('diaryTextarea').value;
            
            // ì €ì¥ í™•ì¸
            if (!confirm('ì¼ê¸°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                console.log('ì €ì¥ ì‹œì‘:', {date: selectedDate, content: content});
                
                // ë‚ ì§œ í˜•ì‹ ë³€í™˜: 2026-01-27 â†’ 26.01.27
                let convertedDate = selectedDate;
                if (selectedDate.includes('-')) {
                    const parts = selectedDate.split('-');
                    const year = parts[0].substring(2);  // 2026 â†’ 26
                    const month = parts[1];              // 01
                    const day = parts[2];                // 27
                    convertedDate = `${year}.${month}.${day}`;  // 26.01.27
                }
                
                console.log('ë³€í™˜ëœ ë‚ ì§œ:', convertedDate);
                
                // Google Sheetsì— ì €ì¥
                fetch(DIARY_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        date: convertedDate,
                        content: content
                    })
                }).then(() => {
                    console.log('Apps Script í˜¸ì¶œ ì™„ë£Œ');
                }).catch(err => {
                    console.error('Apps Script ì˜¤ë¥˜:', err);
                });
                
                // ë¡œì»¬ì—ë„ ì €ì¥ (window.storageê°€ ìˆìœ¼ë©´)
                try {
                    if (window.storage && window.storage.set) {
                        await window.storage.set(`diary_${selectedDate}`, content);
                    }
                } catch (e) {
                    console.log('ë¡œì»¬ ì €ì¥ ìŠ¤í‚µ:', e);
                }
                
                lastDiaryContent = content;
                unsavedDiary = false;
                
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                // diary ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                setTimeout(async () => {
                    await loadDiaryData();
                }, 2000);
                
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        window.onload = init;
    </script>
</body>
</html>
